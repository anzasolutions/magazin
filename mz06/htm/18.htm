<html><head><meta http-equiv=Content-Type content="text/html; charset=iso-8859-2"><link rel=stylesheet href="magazin.css" TYPE="text/css"><title>MagaZin #6 :: grudzieñ 2001</title></head><body link=478DE7 vlink=478DE7 alink=478DE7 topmargin=0 bottommargin=0 bgcolor="#000000"><div align=center><center><table border=0 width=700 cellspacing=0 cellpadding=0 height=1 bgcolor="#FFFFFF"><tr><td width=697 height=154 valign=top><img border=0 src="../img/up.png" width=700 height=150></td></tr></center><tr><td width=697 height=1 valign=top><table border=0 width=700 cellspacing=0 cellpadding=0 height=1 bgcolor="#FFFFFF"><tr><center><td width=697 height=1 valign=top></center><div align=center><center><table border=0 width="92%" cellspacing=0 cellpadding=4><tr><td width="10%" valign=middle><a href="17.htm"><img border=0 src="../img/4.gif" align=right width=50 height=25></a></td><td width="23%" valign=middle><font face=Arial size=1>poprzednia</font></td><td width="33%" valign=middle><p align=center><a href="spis.htm"><img border=0 src="../img/6.gif" width=200 height=20></a></td><td width="23%" valign=middle><p align=right><font size=1 face=Arial>nastêpna</font></td><td width="10%" valign=middle><a href="19.htm" class=link2><img border=0 src="../img/3.gif" width=50 height=25></a></td></tr></table></center></div></td></tr></table></td></tr><center><tr><td width=697 height=83 valign=top><div align=center><center><table border=0 width="92%" height=1 cellspacing=10 cellpadding=2><tr><td width="100%" height=5 valign=top colspan=2></td></tr><tr><td width="100%" height=16 valign=top bgcolor="#000000" colspan=2><img border=0 src="../img/13a.gif" width=225 height=14></td></tr><tr><td width="100%" height=1 valign=top colspan=2><font face=Arial size=2><br></font><div align=center><center><table border=0 width="100%" cellspacing=0 cellpadding=0><tr><td width="64%" valign=top height=30><font class=u>PHP w s³u¿bie ICQ</font></td></center></center></center><td width="36%" valign=top height=30><p align=right></td></tr></table></div><center><center></center></center></td></tr><tr><td width="50%" height=112 valign=top><p align=justify><font class=9pt>Umieszczone na serwerze AOL/Mirablis oprogramowanie pozwala wy¶wietliæ nasz status (offline, online) na stronie WWW, jednak nie pozwala na wykorzystanie w³asnego tekstu/ grafiki - mo¿emy wybieraæ jedynie z kilku predefiniowanych zestawów. Z pomoc± PHP mo¿emy jednak obej¶æ te ograniczenie i wykorzystaæ dowolny tekst/grafikê.<br> Ja co prawda jestem wielbicielem charakterystycznego "kwiatka", jednak z tego co s³ysza³em, wielu webmasterów chcia³oby mieæ mo¿liwo¶æ zastosowania w³asnej grafiki. Przyjrzyjmy siê wiêc bli¿ej naszemu problemowi. </font><p align=justify class=9ptV><font color="#478DE7">&lt;img SRC=&quot;http://wwp.icq.com/scripts/<br><online.dll?icq=XXXXXX&amp;img=5"></font><p align=justify><font class=9pt>To jest kod, jaki nale¿y umie¶ciæ na stronie (oczywi¶cie zamiast XXXXXX trzeba podaæ swój numer UIN a cyferka 5 odpowiada za styl wy¶wietlanego obrazka - te¿ mo¿na wybraæ co¶ innego). Jak widaæ kod jest do¶æ prosty, jednak zmodyfikowaæ zbytnio go siê nie da :(. Z pozoru problem jest nie do rozwi±zania - kod potrafi wy¶wietliæ jedynie obrazek z predefiniowanego zestawu i tyle - usuñmy go wiêc, lub lepiej skomentujmy z poziomu php, bowiem przyda nam siê adres tego skryptu. </font><p align=justify><font class=9ptv><font color="#478DE7">&lt;? //&lt;img SRC=&quot;http://wwp.icq.com/scripts/<br><online.dll?icq=XXXXXX&amp;img=5"> ?></font><p align=justify><font class=9pt>Zapewne co dociekliwsi/bardziej zdesperowani u¿ytkownicy spróbuj± wpisaæ podany w kodzie obrazka adres w pasek adresowy swej przegl±darki. Niestety, taka próba nie przybli¿y nas do niczego - w oknie browsera znów pojawi siê "niechciany" obrazek prezentuj±cy nasz status. Có¿ wiêc robiæ? Zagl±damy do manuala PHP i... Eureka! Co¶ jest - dzia³ Socket functions wydaje siê opisywaæ funkcje nam przydatne. Spróbujmy wiêc skorzystaæ z funkcji fsockopen() (205890 to mój UIN): </font><p align=justify><font color="#478DE7">&lt;? //&lt;img SRC=&quot;http://wwp.icq.com/scripts/<br><online.dll?icq=205890&amp;img=5"><br> error_reporting(0);<br> $fp = fsockopen ("wwp.icq.com", 80, $errno, $errstr, 30);<br> if (!$fp) {<br> echo "echo disabled(2)";<br> break;<br> }<br> else {<br> fputs ($fp, "GET /scripts/online.dll?icq=205890&amp;img=5 HTTP/1.0\n\n");<br> while (!feof($fp)) {<br> $wynik = fgets ($fp,128);<br> echo $wynik;<br> }<br> fclose ($fp);<br> }<br><?>></font><p align=justify><font class=9pt>I co siê dzieje? Na ekranie wy¶wietli³ siê ci±g dziwnych znaczków w stylu: </font><p align=justify><font color="#478DE7">HTTP/1.0 200 OK Content-type: image/gif GIF89a (®ÔÓtR ¶ó¡# % áw` &plusmn;40 À ìt·&#8230;Wb¨ó¤¶çÄ </font><p align=justify><font class=9pt>Có¿ to jest? Ano mo¿na siê domy¶liæ, i¿ jest to obrazek (image/gif) wy¶wietlany jako nasz aktualny status. I w tym momencie jeste¶my ju¿ w domu - jak siê zaraz przekonamy ka¿dy obrazek bêdzie przedstawiony jako odmienny ci±g znaków - wystarczy wiêc przy pomocy instrukcji if lub switch sprawdziæ warto¶æ zmiennej $wynik i wy¶wietliæ odpowiedni obrazek/ tekst. Najpierw sprawd¼my jednak jak wygl±da zwracany przez nasz skrypt ci±g znaków w zale¿no¶ci od statusu naszego ICQ: </font><p align=justify><font color="#478DE7">Offline (nie po³±czony):&nbsp;<br> HTTP/1.0 200 OK Content-type: image/gif GIF89a (®ÔÓtR ¶ó¡# % áw` &plusmn;40 À ìt·&#8230;Wb¨ó¤¶çÄ&nbsp;<br><br>Online (po³±czony):&nbsp;<br> HTTP/1.0 200 OK Content-type: image/gif GIF89a ( ®ÔÓtR ¶ó¡# % á7@ &plusmn;40 À Uìt·"WB¨ó¤¶ç"<br></font></font><td width="50%" height=93 valign=top><font class=9ptv><p align=justify><font class=9pt>Istnieje jeszcze status Disabled (wy³±czony???), jednak tutaj znajomo¶æ szczegó³ów nie jest nam potrzebna - za pewnik mo¿na przyj±æ, ¿e gdy aktualny status nie jest statusem Offline ani Online to jest to Disabled (co, w naszym przypadku, bêdzie równie dobrze mog³o oznaczaæ, ¿e nasz skrypt nie móg³ po³±czyæ siê z serwerem ICQ).&nbsp;<br> A wiêc przed nami stoi kolejne zadanie: musimy rozpoznaæ, który ci±g znaków otrzymujemy. W PHP jest to do¶æ proste - istnieje sporo funkcji, które mo¿na tutaj wykrozystaæ. My skorzystamy z eregi(); </font><p align=justify><font class=9ptv><font color="#478DE7">$online = eregi ("á7@", $wynik);<br><br>$offline = eregi ("áw`", $wynik); </font><p align=justify><font class=9pt>Co robi ów kod? Funkcja eregi wyszukuje w podanym ci±gu (tutaj $wynik - czyli odpowiedzi z serwera icq) podanego ci±gu (tutaj "á7@" dla on a "áw`" dla offline) - je¶li go znajdzie zwraca prawdê ("1"). Problemem nie bêdzie wiêc wy¶wietlenie odpowiedniego napisu/ obrazka w zale¿no¶ci od tego, czy jeste¶my on czy offline: </font><p align=justify><font class=9ptv><font color="#478DE7">if ($online==1)<br> {echo "online";}<br> elseif ($offline==1)<br> {echo "offline";}<br><br>if ($online==0&amp;&amp;$offline==0||!$online&amp;&amp;!$offline)<br> {echo &quot;disabled&quot;;} </font><p align=justify><font class=9pt>I co, ju¿ koniec? Tak :). Ca³y skrypt wygl±da wiêc tak: </font><p align=justify><font class=9ptv><font color="#478DE7">&lt;?<br> error_reporting(0);<br> /*wy³±czamy wy¶wietlanie b³êdów*/<br> $fp = fsockopen ("wwp.icq.com", 80, &amp;$errno, &amp;$errstr, 30);<br> /*otwieramy po³±czenie z serwerem icq*/<br> if (!$fp) {<br> echo "disabled(2)";<br> break;<br> }&nbsp;<br> /*je¶li co¶ pójdzie nie tak wy¶wietlamy disabled i koñczymy dzia³anie skryptu*/<br> else {<br> fputs ($fp, "GET /scripts/online.dll?icq=XXXXXX&amp;img=5 HTTP/1.0\n\n");<br> /* dostajemy siê do w³a¶ciwego skrypciora na serwerze icq*/<br> while (!feof($fp))&nbsp;<br> {<br><br>if (!$wynik = &amp;fgets ($fp, 128))<br> {echo "disabled(1)";<br> break;<br> }<br> /* pobieramy ci±g znaków, je¶li co¶ jest nie tak wy¶wietlamy disabled izatrzymujemy skrypt, je¶li wszystko jest ok... */<br> else<br> {<br> $online = eregi ("á7@", $wynik);<br> $offline = eregi ("áw`", $wynik);<br> }<br> if ($online==1)<br> {echo "online";}<br> elseif ($offline==1)<br> {echo "offline";}<br> }&nbsp;<br> fclose ($fp);<br> /* sprawdzamy nasz status i wy¶wietlamy odpowiedni napis*/<br> }<br> if ($online==0&amp;&amp;$offline==0||!$online&amp;&amp;!$offline)<br> {echo "disabled";}<br> /* je¶li nie ma nas online ani offline wy¶wietlamy disabled*/<br><?>></font><p align=justify><font class=9pt>Oczywi¶cie, jest to wersja ma</font></font></font></font></font><font class=9pt>ks</font><font class=9ptv><font class=9pt><malnie uproszczona - zamiast tekstów w stylu "online" mo¿emy wy¶wietlaæ obrazek (&lt;img src=\"obrazek.gif\">) lub cokolwiek innego. Je¶li zamierzamy intensywnie (tj. na wielu stronach) korzystaæ z tego skryptu, warto by by³o ca³o¶æ zdefiniowaæ jako funkcjê do której przekazujemy jeden parametr - nr. UIN. Ale z tym, mam nadziejê, ju¿ sobie poradzicie :).&nbsp><br></font><font class=9ptv><br></font></font></tr><tr><td width="100%" height=1 valign=top colspan=2><p align=right><font class=9pt><b>pozeraczmozgow</b><a href="mailto:magazin@hoga.pl" class=link><br> magazin@hoga.pl<br></a></font></tr><tr><td width="100%" height=1 valign=middle colspan=2 bgcolor="#000000"><b><font face=Verdana color="#FFFFFF" size=1>&nbsp;Copyright &copy; MagaZin 2001</font></b></td></tr></table><table border=0 width="92%" height=1 cellspacing=10 cellpadding=2><center></table></div></center></td></tr></table></div></body></html>